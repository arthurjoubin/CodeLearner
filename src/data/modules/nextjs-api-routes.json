{
  "module": {
    "id": "nextjs-api-routes",
    "title": "API Routes",
    "description": "Build backend APIs with Next.js Route Handlers",
    "icon": "Route",
    "requiredXp": 7500,
    "color": "from-blue-600 to-indigo-700",
    "courseId": "nextjs"
  },
  "lessons": [
    {
      "id": "route-handlers-intro",
      "moduleId": "nextjs-api-routes",
      "title": "Route Handlers",
      "order": 1,
      "difficulty": "intermediate",
      "content": "# Essential to know\n- Route Handlers replace API routes in App Router\n- Create route.js files in app/api directories\n- Export HTTP method handlers (GET, POST, PUT, DELETE, PATCH)\n- Return NextResponse for consistent responses\n- Support dynamic route segments\n\n---\n\n# Building APIs with Route Handlers\n\n## Basic Route Handler\n\n```javascript\n// app/api/hello/route.js\nimport { NextResponse } from 'next/server';\n\nexport async function GET() {\n  return NextResponse.json({ message: 'Hello World' });\n}\n```\n\nAccess at: `http://localhost:3000/api/hello`\n\n## HTTP Methods\n\nExport functions for each HTTP method:\n\n```javascript\n// app/api/users/route.js\nimport { NextResponse } from 'next/server';\n\n// GET /api/users\nexport async function GET() {\n  const users = await db.user.findMany();\n  return NextResponse.json(users);\n}\n\n// POST /api/users\nexport async function POST(request) {\n  const body = await request.json();\n  const user = await db.user.create({ data: body });\n  \n  return NextResponse.json(user, { status: 201 });\n}\n\n// PUT /api/users\nexport async function PUT(request) {\n  const body = await request.json();\n  const user = await db.user.update({\n    where: { id: body.id },\n    data: body\n  });\n  return NextResponse.json(user);\n}\n\n// DELETE /api/users\nexport async function DELETE(request) {\n  const { searchParams } = new URL(request.url);\n  const id = searchParams.get('id');\n  \n  await db.user.delete({ where: { id } });\n  return NextResponse.json({ deleted: true });\n}\n```\n\n## Dynamic Routes\n\nHandle specific resources:\n\n```javascript\n// app/api/users/[id]/route.js\nimport { NextResponse } from 'next/server';\n\nexport async function GET(request, { params }) {\n  const user = await db.user.findUnique({\n    where: { id: params.id }\n  });\n  \n  if (!user) {\n    return NextResponse.json(\n      { error: 'User not found' },\n      { status: 404 }\n    );\n  }\n  \n  return NextResponse.json(user);\n}\n\nexport async function PUT(request, { params }) {\n  const body = await request.json();\n  const user = await db.user.update({\n    where: { id: params.id },\n    data: body\n  });\n  return NextResponse.json(user);\n}\n\nexport async function DELETE(request, { params }) {\n  await db.user.delete({ where: { id: params.id } });\n  return NextResponse.json({ deleted: true });\n}\n```\n\n## Request Handling\n\n### Accessing Request Body\n\n```javascript\nexport async function POST(request) {\n  // JSON body\n  const json = await request.json();\n  \n  // Form data\n  const formData = await request.formData();\n  const name = formData.get('name');\n  \n  // Text\n  const text = await request.text();\n  \n  // Blob (files)\n  const blob = await request.blob();\n}\n```\n\n### Query Parameters\n\n```javascript\nexport async function GET(request) {\n  const { searchParams } = new URL(request.url);\n  \n  const page = searchParams.get('page') || '1';\n  const limit = searchParams.get('limit') || '10';\n  const search = searchParams.get('q');\n  \n  // /api/users?page=2&limit=20&q=john\n}\n```\n\n### Headers\n\n```javascript\nexport async function GET(request) {\n  const authHeader = request.headers.get('authorization');\n  const contentType = request.headers.get('content-type');\n  \n  // Get all headers\n  const headers = Object.fromEntries(request.headers);\n}\n```\n\n## Response Helpers\n\n### NextResponse\n\n```javascript\nimport { NextResponse } from 'next/server';\n\n// JSON response\nNextResponse.json({ data: 'value' });\n\n// With status\nNextResponse.json(\n  { error: 'Not found' },\n  { status: 404 }\n);\n\n// With headers\nNextResponse.json(\n  { data: 'value' },\n  {\n    status: 200,\n    headers: {\n      'X-Custom-Header': 'value',\n      'Cache-Control': 'max-age=3600'\n    }\n  }\n);\n\n// Redirect\nreturn NextResponse.redirect(new URL('/login', request.url));\n\n// Rewrite\nreturn NextResponse.rewrite(new URL('/api/other', request.url));\n\n// Plain text\nreturn new NextResponse('Hello World', {\n  status: 200,\n  headers: { 'Content-Type': 'text/plain' }\n});\n```\n\n## Route Segment Config\n\n```javascript\n// app/api/data/route.js\nexport const dynamic = 'force-dynamic'; // No caching\nexport const dynamic = 'force-static'; // Static generation\nexport const revalidate = 60; // Revalidate every 60s\n\nexport const runtime = 'nodejs'; // Use Node.js runtime\nexport const runtime = 'edge'; // Use Edge runtime\n\nexport async function GET() {\n  // ...\n}\n```\n\n## CORS Handling\n\n```javascript\n// app/api/external/route.js\nimport { NextResponse } from 'next/server';\n\nexport async function GET(request) {\n  const data = await fetchExternalData();\n  \n  return NextResponse.json(data, {\n    headers: {\n      'Access-Control-Allow-Origin': '*',\n      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE',\n      'Access-Control-Allow-Headers': 'Content-Type, Authorization'\n    }\n  });\n}\n\n// Handle OPTIONS for preflight\nexport async function OPTIONS() {\n  return NextResponse.json({}, {\n    headers: {\n      'Access-Control-Allow-Origin': '*',\n      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE',\n      'Access-Control-Allow-Headers': 'Content-Type, Authorization'\n    }\n  });\n}\n```\n\n## File Uploads\n\n```javascript\n// app/api/upload/route.js\nimport { writeFile } from 'fs/promises';\nimport { NextResponse } from 'next/server';\nimport path from 'path';\n\nexport async function POST(request) {\n  try {\n    const formData = await request.formData();\n    const file = formData.get('file');\n    \n    if (!file) {\n      return NextResponse.json(\n        { error: 'No file uploaded' },\n        { status: 400 }\n      );\n    }\n    \n    const bytes = await file.arrayBuffer();\n    const buffer = Buffer.from(bytes);\n    \n    // Save to disk\n    const uploadDir = path.join(process.cwd(), 'public', 'uploads');\n    const filePath = path.join(uploadDir, file.name);\n    await writeFile(filePath, buffer);\n    \n    return NextResponse.json({\n      message: 'File uploaded successfully',\n      fileName: file.name,\n      url: `/uploads/${file.name}`\n    });\n  } catch (error) {\n    return NextResponse.json(\n      { error: 'Upload failed' },\n      { status: 500 }\n    );\n  }\n}\n```\n\n## Streaming Responses\n\n```javascript\n// app/api/stream/route.js\nimport { NextResponse } from 'next/server';\n\nexport async function GET() {\n  const encoder = new TextEncoder();\n  \n  const stream = new ReadableStream({\n    async start(controller) {\n      // Send data chunks\n      controller.enqueue(encoder.encode('Starting...\\n'));\n      \n      await new Promise(resolve => setTimeout(resolve, 1000));\n      controller.enqueue(encoder.encode('Processing...\\n'));\n      \n      await new Promise(resolve => setTimeout(resolve, 1000));\n      controller.enqueue(encoder.encode('Done!\\n'));\n      \n      controller.close();\n    }\n  });\n  \n  return new NextResponse(stream, {\n    headers: { 'Content-Type': 'text/plain' }\n  });\n}\n```\n\n## Error Handling\n\n```javascript\n// app/api/users/route.js\nimport { NextResponse } from 'next/server';\n\nexport async function GET() {\n  try {\n    const users = await db.user.findMany();\n    return NextResponse.json(users);\n  } catch (error) {\n    console.error('Database error:', error);\n    \n    return NextResponse.json(\n      {\n        error: 'Failed to fetch users',\n        message: process.env.NODE_ENV === 'development'\n          ? error.message\n          : undefined\n      },\n      { status: 500 }\n    );\n  }\n}\n```"
    },
    {
      "id": "route-auth",
      "moduleId": "nextjs-api-routes",
      "title": "Authentication in Routes",
      "order": 2,
      "difficulty": "intermediate",
      "content": "# Essential to know\n- Verify JWT tokens or session cookies\n- Protect routes with middleware\n- Return 401 for unauthorized, 403 for forbidden\n- Use secure, httpOnly cookies for sessions\n- Implement rate limiting\n\n---\n\n# Securing API Routes\n\n## JWT Authentication\n\n```javascript\n// app/api/protected/route.js\nimport { NextResponse } from 'next/server';\nimport jwt from 'jsonwebtoken';\n\nexport async function GET(request) {\n  try {\n    // Get token from header\n    const authHeader = request.headers.get('authorization');\n    \n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      return NextResponse.json(\n        { error: 'No token provided' },\n        { status: 401 }\n      );\n    }\n    \n    const token = authHeader.split(' ')[1];\n    \n    // Verify token\n    const decoded = jwt.verify(token, process.env.JWT_SECRET);\n    \n    // Token is valid, proceed\n    return NextResponse.json({\n      message: 'Protected data',\n      user: decoded\n    });\n  } catch (error) {\n    return NextResponse.json(\n      { error: 'Invalid token' },\n      { status: 401 }\n    );\n  }\n}\n```\n\n## Session Cookie Authentication\n\n```javascript\n// app/api/protected/route.js\nimport { NextResponse } from 'next/server';\nimport { cookies } from 'next/headers';\n\nexport async function GET(request) {\n  const cookieStore = cookies();\n  const sessionToken = cookieStore.get('session')?.value;\n  \n  if (!sessionToken) {\n    return NextResponse.json(\n      { error: 'Not authenticated' },\n      { status: 401 }\n    );\n  }\n  \n  // Verify session\n  const session = await verifySession(sessionToken);\n  \n  if (!session) {\n    return NextResponse.json(\n      { error: 'Invalid session' },\n      { status: 401 }\n    );\n  }\n  \n  return NextResponse.json({\n    message: 'Protected data',\n    userId: session.userId\n  });\n}\n```\n\n## Helper Functions\n\n```javascript\n// lib/auth.js\nimport jwt from 'jsonwebtoken';\nimport { cookies } from 'next/headers';\n\nexport async function verifyAuth(request) {\n  const cookieStore = cookies();\n  const token = cookieStore.get('token')?.value;\n  \n  if (!token) {\n    return null;\n  }\n  \n  try {\n    const decoded = jwt.verify(token, process.env.JWT_SECRET);\n    return decoded;\n  } catch {\n    return null;\n  }\n}\n\nexport function requireAuth(handler) {\n  return async function(request, context) {\n    const user = await verifyAuth(request);\n    \n    if (!user) {\n      return NextResponse.json(\n        { error: 'Unauthorized' },\n        { status: 401 }\n      );\n    }\n    \n    // Add user to context\n    return handler(request, { ...context, user });\n  };\n}\n```\n\nUsage:\n\n```javascript\n// app/api/users/me/route.js\nimport { requireAuth } from '@/lib/auth';\nimport { NextResponse } from 'next/server';\n\nexport const GET = requireAuth(async function(request, { user }) {\n  const userData = await db.user.findUnique({\n    where: { id: user.id }\n  });\n  \n  return NextResponse.json(userData);\n});\n```\n\n## Role-Based Access\n\n```javascript\n// lib/auth.js\nexport function requireRole(roles) {\n  return function(handler) {\n    return async function(request, context) {\n      const user = await verifyAuth(request);\n      \n      if (!user) {\n        return NextResponse.json(\n          { error: 'Unauthorized' },\n          { status: 401 }\n        );\n      }\n      \n      if (!roles.includes(user.role)) {\n        return NextResponse.json(\n          { error: 'Forbidden' },\n          { status: 403 }\n        );\n      }\n      \n      return handler(request, { ...context, user });\n    };\n  };\n}\n```\n\n```javascript\n// app/api/admin/users/route.js\nimport { requireRole } from '@/lib/auth';\n\nexport const GET = requireRole(['admin'])(async function(request, { user }) {\n  const users = await db.user.findMany();\n  return NextResponse.json(users);\n});\n```\n\n## Rate Limiting\n\n```javascript\n// lib/rate-limit.js\nimport { LRUCache } from 'lru-cache';\n\nconst rateLimitCache = new LRUCache({\n  max: 500,\n  ttl: 1000 * 60 * 15, // 15 minutes\n});\n\nexport function rateLimit(limit = 10, windowMs = 900000) {\n  return async function(request) {\n    const ip = request.ip || 'anonymous';\n    const now = Date.now();\n    \n    const windowStart = now - windowMs;\n    const requests = rateLimitCache.get(ip) || [];\n    \n    // Filter requests within window\n    const recentRequests = requests.filter(time => time > windowStart);\n    \n    if (recentRequests.length >= limit) {\n      return {\n        success: false,\n        limit,\n        remaining: 0,\n        resetTime: new Date(requests[0] + windowMs)\n      };\n    }\n    \n    recentRequests.push(now);\n    rateLimitCache.set(ip, recentRequests);\n    \n    return {\n      success: true,\n      limit,\n      remaining: limit - recentRequests.length - 1\n    };\n  };\n}\n```\n\n```javascript\n// app/api/login/route.js\nimport { rateLimit } from '@/lib/rate-limit';\n\nconst limiter = rateLimit(5, 15 * 60 * 1000); // 5 attempts per 15 minutes\n\nexport async function POST(request) {\n  const rateLimitResult = await limiter(request);\n  \n  if (!rateLimitResult.success) {\n    return NextResponse.json(\n      {\n        error: 'Too many attempts',\n        retryAfter: rateLimitResult.resetTime\n      },\n      {\n        status: 429,\n        headers: {\n          'X-RateLimit-Limit': rateLimitResult.limit.toString(),\n          'X-RateLimit-Remaining': '0',\n          'X-RateLimit-Reset': rateLimitResult.resetTime.toISOString()\n        }\n      }\n    );\n  }\n  \n  // Process login...\n}\n```"
    }
  ],
  "exercises": [
    {
      "id": "api-routes-ex-1",
      "type": "quiz",
      "lessonId": "route-handlers-intro",
      "moduleId": "nextjs-api-routes",
      "title": "Route Handler Implementation",
      "difficulty": "easy",
      "questions": [
        {
          "question": "What file should you create to define an API route at /api/users?",
          "options": [
            "app/api/users.js",
            "app/api/users/route.js",
            "pages/api/users.js",
            "api/users/route.js"
          ],
          "correctAnswer": 1,
          "explanation": "In Next.js App Router, you create a route.js file inside the directory structure. For /api/users, you create app/api/users/route.js"
        },
        {
          "question": "How do you access route parameters in a Route Handler?",
          "options": [
            "req.params.id",
            "params.id from the second argument",
            "request.query.id",
            "context.params.id"
          ],
          "correctAnswer": 1,
          "explanation": "In Route Handlers, dynamic route parameters are accessed via the second function argument: export async function GET(request, { params }) { params.id }"
        }
      ]
    }
  ]
}
