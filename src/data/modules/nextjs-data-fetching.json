{
  "module": {
    "id": "nextjs-data-fetching",
    "title": "Data Fetching and API Routes",
    "description": "Fetch data in Server Components and create backend API routes",
    "icon": "Database",
    "requiredXp": 3200,
    "color": "from-blue-500 to-indigo-600",
    "courseId": "nextjs"
  },
  "lessons": [
    {
      "id": "nextjs-fetching",
      "moduleId": "nextjs-data-fetching",
      "title": "Fetching Data in Server Components",
      "order": 1,
      "difficulty": "intermediate",
      "content": "# Essential to know\n- Server Components can fetch data directly\n- Use async/await in components\n- fetch() is automatically cached\n- Revalidation controls cache updates\n- Error handling with try/catch\n\n---\n\n# Data Fetching in Next.js\n\n## Direct Data Fetching\n\nServer Components can fetch data directly:\n\n```javascript\n// app/posts/page.js\nasync function getPosts() {\n  const res = await fetch('https://api.example.com/posts');\n  if (!res.ok) throw new Error('Failed to fetch');\n  return res.json();\n}\n\nexport default async function PostsPage() {\n  const posts = await getPosts();\n  \n  return (\n    <main>\n      <h1>Blog Posts</h1>\n      {posts.map(post => (\n        <article key={post.id}>\n          <h2>{post.title}</h2>\n        </article>\n      ))}\n    </main>\n  );\n}\n```\n\n**Key points:**\n- Component is `async`\n- Fetch happens on the server\n- No useEffect needed\n- HTML sent to browser already has data\n\n## Caching Behavior\n\n**Default: fetch is cached**\n```javascript\n// This result is cached\nconst data = await fetch('https://api.example.com/data');\n```\n\n**Disable caching:**\n```javascript\n// Always fetch fresh data\nconst data = await fetch(url, { cache: 'no-store' });\n\n// Or revalidate after time\nconst data = await fetch(url, { next: { revalidate: 60 } });  // 60 seconds\n```\n\n## Revalidation Strategies\n\n**Time-based:**\n```javascript\n// Revalidate every hour\nexport const revalidate = 3600;\n\nexport default async function Page() {\n  const data = await fetch(url, { next: { revalidate: 3600 } });\n  // ...\n}\n```\n\n**On-demand (webhooks):**\n```javascript\n// app/api/revalidate/route.js\nexport async function POST(request) {\n  const { tag } = await request.json();\n  revalidateTag(tag);\n  return Response.json({ revalidated: true });\n}\n```\n\n## Parallel Data Fetching\n\nFetch multiple resources in parallel:\n\n```javascript\nexport default async function Dashboard() {\n  // These fetch in parallel!\n  const [user, posts, notifications] = await Promise.all([\n    getUser(),\n    getPosts(),\n    getNotifications()\n  ]);\n  \n  return (\n    <div>\n      <UserCard user={user} />\n      <PostList posts={posts} />\n      <NotificationBell count={notifications.length} />\n    </div>\n  );\n}\n```\n\n## Error Handling\n\n```javascript\nexport default async function Page() {\n  try {\n    const data = await fetchData();\n    return <SuccessView data={data} />;\n  } catch (error) {\n    return <ErrorView message={error.message} />;\n  }\n}\n```",
      "codeExample": "// app/users/page.js\nasync function getUsers() {\n  // Simulated API call\n  await new Promise(resolve => setTimeout(resolve, 1000));\n  \n  return [\n    { id: 1, name: 'Alice', email: 'alice@example.com' },\n    { id: 2, name: 'Bob', email: 'bob@example.com' },\n    { id: 3, name: 'Charlie', email: 'charlie@example.com' }\n  ];\n}\n\nexport default async function UsersPage() {\n  const users = await getUsers();\n  \n  return (\n    <main>\n      <h1>Users</h1>\n      <table>\n        <thead>\n          <tr>\n            <th>Name</th>\n            <th>Email</th>\n          </tr>\n        </thead>\n        <tbody>\n          {users.map(user => (\n            <tr key={user.id}>\n              <td>{user.name}</td>\n              <td>{user.email}</td>\n            </tr>\n          ))}\n        </tbody>\n      </table>\n    </main>\n  );\n}\n\n// With loading state\nexport async function generateMetadata() {\n  return {\n    title: 'Users List',\n  };\n}"
    },
    {
      "id": "nextjs-api-routes",
      "moduleId": "nextjs-data-fetching",
      "title": "Creating API Routes",
      "order": 2,
      "difficulty": "intermediate",
      "content": "# Essential to know\n- API routes in app/api/*\n- Export HTTP method handlers (GET, POST, PUT, DELETE)\n- Use Response.json() to return JSON\n- Access request body with request.json()\n- Route handlers can access database directly\n\n---\n\n# API Routes in Next.js\n\n## Basic API Route\n\nCreate API endpoints in `app/api/` folder:\n\n```javascript\n// app/api/hello/route.js\nexport async function GET() {\n  return Response.json({ message: 'Hello World!' });\n}\n```\n\nAccess at: `http://localhost:3000/api/hello`\n\n## HTTP Methods\n\nHandle different HTTP methods:\n\n```javascript\n// app/api/users/route.js\n\n// GET /api/users\nexport async function GET() {\n  const users = await db.getUsers();\n  return Response.json(users);\n}\n\n// POST /api/users\nexport async function POST(request) {\n  const body = await request.json();\n  const newUser = await db.createUser(body);\n  return Response.json(newUser, { status: 201 });\n}\n```\n\n## Dynamic API Routes\n\n```javascript\n// app/api/users/[id]/route.js\n\nexport async function GET(request, { params }) {\n  const user = await db.getUser(params.id);\n  \n  if (!user) {\n    return Response.json(\n      { error: 'User not found' },\n      { status: 404 }\n    );\n  }\n  \n  return Response.json(user);\n}\n\nexport async function PUT(request, { params }) {\n  const body = await request.json();\n  const updated = await db.updateUser(params.id, body);\n  return Response.json(updated);\n}\n\nexport async function DELETE(request, { params }) {\n  await db.deleteUser(params.id);\n  return new Response(null, { status: 204 });\n}\n```\n\n## Request and Response\n\n**Reading request body:**\n```javascript\nexport async function POST(request) {\n  const body = await request.json();      // JSON body\n  const formData = await request.formData();  // Form data\n  \n  // Access headers\n  const authHeader = request.headers.get('authorization');\n  \n  return Response.json({ received: body });\n}\n```\n\n**Setting response status and headers:**\n```javascript\nexport async function POST(request) {\n  const data = await request.json();\n  \n  return Response.json(\n    { id: 1, ...data },\n    {\n      status: 201,\n      headers: {\n        'X-Custom-Header': 'value'\n      }\n    }\n  );\n}\n```\n\n## Full CRUD Example\n\n```javascript\n// app/api/posts/route.js\nlet posts = [\n  { id: '1', title: 'First Post', content: 'Hello!' }\n];\n\nexport async function GET() {\n  return Response.json(posts);\n}\n\nexport async function POST(request) {\n  const body = await request.json();\n  const newPost = {\n    id: Date.now().toString(),\n    ...body\n  };\n  posts.push(newPost);\n  return Response.json(newPost, { status: 201 });\n}\n\n// app/api/posts/[id]/route.js\nexport async function GET(request, { params }) {\n  const post = posts.find(p => p.id === params.id);\n  \n  if (!post) {\n    return Response.json(\n      { error: 'Not found' },\n      { status: 404 }\n    );\n  }\n  \n  return Response.json(post);\n}\n\nexport async function PUT(request, { params }) {\n  const body = await request.json();\n  const index = posts.findIndex(p => p.id === params.id);\n  \n  if (index === -1) {\n    return Response.json(\n      { error: 'Not found' },\n      { status: 404 }\n    );\n  }\n  \n  posts[index] = { ...posts[index], ...body };\n  return Response.json(posts[index]);\n}\n\nexport async function DELETE(request, { params }) {\n  posts = posts.filter(p => p.id !== params.id);\n  return new Response(null, { status: 204 });\n}\n```",
      "codeExample": "// app/api/todos/route.js\nlet todos = [\n  { id: 1, text: 'Learn Next.js', completed: false },\n  { id: 2, text: 'Build an app', completed: false }\n];\n\nexport async function GET() {\n  return Response.json(todos);\n}\n\nexport async function POST(request) {\n  const { text } = await request.json();\n  \n  const newTodo = {\n    id: Date.now(),\n    text,\n    completed: false\n  };\n  \n  todos.push(newTodo);\n  return Response.json(newTodo, { status: 201 });\n}\n\n// app/api/todos/[id]/route.js\nexport async function PATCH(request, { params }) {\n  const { completed } = await request.json();\n  const todo = todos.find(t => t.id === parseInt(params.id));\n  \n  if (!todo) {\n    return Response.json({ error: 'Todo not found' }, { status: 404 });\n  }\n  \n  todo.completed = completed;\n  return Response.json(todo);\n}\n\nexport async function DELETE(request, { params }) {\n  todos = todos.filter(t => t.id !== parseInt(params.id));\n  return new Response(null, { status: 204 });\n}\n\n// Client-side usage\n// app/components/TodoList.js\n'use client';\n\nimport { useState, useEffect } from 'react';\n\nexport default function TodoList() {\n  const [todos, setTodos] = useState([]);\n  \n  useEffect(() => {\n    fetch('/api/todos')\n      .then(r => r.json())\n      .then(setTodos);\n  }, []);\n  \n  const toggleTodo = async (id, completed) => {\n    await fetch(`/api/todos/${id}`, {\n      method: 'PATCH',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ completed })\n    });\n    \n    setTodos(todos.map(t =>\n      t.id === id ? { ...t, completed } : t\n    ));\n  };\n  \n  return (\n    <ul>\n      {todos.map(todo => (\n        <li key={todo.id}>\n          <input\n            type=\"checkbox\"\n            checked={todo.completed}\n            onChange={(e) => toggleTodo(todo.id, e.target.checked)}\n          />\n          {todo.text}\n        </li>\n      ))}\n    </ul>\n  );\n}"
    },
    {
      "id": "nextjs-server-actions",
      "moduleId": "nextjs-data-fetching",
      "title": "Server Actions",
      "order": 3,
      "difficulty": "advanced",
      "content": "# Essential to know\n- Server Actions = functions that run on the server\n- Called directly from components (no API route needed)\n- Use 'use server' directive\n- Perfect for forms and mutations\n- Automatic progressive enhancement\n\n---\n\n# Server Actions in Next.js\n\n## What are Server Actions?\n\nServer Actions let you call server-side functions directly from your components:\n\n```javascript\n// app/page.js\nasync function createPost(formData) {\n  'use server';\n  \n  const title = formData.get('title');\n  const content = formData.get('content');\n  \n  await db.createPost({ title, content });\n  revalidatePath('/posts');\n}\n\nexport default function Page() {\n  return (\n    <form action={createPost}>\n      <input name=\"title\" placeholder=\"Title\" />\n      <textarea name=\"content\" placeholder=\"Content\" />\n      <button type=\"submit\">Create Post</button>\n    </form>\n  );\n}\n```\n\n**Benefits:**\n- No API route needed\n- Type-safe (TypeScript)\n- Works without JavaScript (progressive enhancement)\n- Automatic CSRF protection\n\n## Creating Server Actions\n\n**Inline (in component file):**\n```javascript\nexport default function Form() {\n  async function handleSubmit(formData) {\n    'use server';\n    // Runs on server!\n    await saveData(formData);\n  }\n  \n  return <form action={handleSubmit}>...</form>;\n}\n```\n\n**Separate file:**\n```javascript\n// app/actions.js\n'use server';\n\nexport async function createUser(formData) {\n  const name = formData.get('name');\n  const email = formData.get('email');\n  \n  await db.createUser({ name, email });\n  redirect('/users');\n}\n\nexport async function deleteUser(userId) {\n  await db.deleteUser(userId);\n  revalidatePath('/users');\n}\n```\n\n```javascript\n// app/page.js\nimport { createUser, deleteUser } from './actions';\n\nexport default function Page() {\n  return (\n    <form action={createUser}>\n      {/* form fields */}\n    </form>\n  );\n}\n```\n\n## With Client Components\n\nServer Actions can be passed to Client Components:\n\n```javascript\n// app/actions.js\n'use server';\n\nexport async function updateLikes(postId) {\n  await db.incrementLikes(postId);\n}\n\n// app/components/LikeButton.js\n'use client';\n\nexport default function LikeButton({ postId, updateLikes }) {\n  return (\n    <button onClick={() => updateLikes(postId)}>\n      ❤️ Like\n    </button>\n  );\n}\n\n// app/page.js\nimport { updateLikes } from './actions';\nimport LikeButton from './components/LikeButton';\n\nexport default function Page() {\n  return <LikeButton postId={1} updateLikes={updateLikes} />;\n}\n```\n\n## Revalidation After Mutations\n\n```javascript\n'use server';\n\nimport { revalidatePath } from 'next/cache';\n\nexport async function createPost(formData) {\n  // Save to database\n  await db.createPost(formData);\n  \n  // Clear cache and regenerate page\n  revalidatePath('/posts');\n  \n  // Or redirect\n  redirect('/posts');\n}\n```\n\n## When to Use What?\n\n**API Routes:**\n- External API consumers\n- Webhooks\n- Complex authentication flows\n\n**Server Actions:**\n- Form submissions\n- Data mutations from UI\n- When you want type safety\n- Progressive enhancement needed",
      "codeExample": "// app/actions.js\n'use server';\n\nimport { revalidatePath } from 'next/cache';\nimport { redirect } from 'next/navigation';\n\nlet posts = [];\n\nexport async function createPost(formData) {\n  const title = formData.get('title');\n  const content = formData.get('content');\n  \n  if (!title || !content) {\n    return { error: 'Title and content required' };\n  }\n  \n  const newPost = {\n    id: Date.now(),\n    title,\n    content,\n    createdAt: new Date()\n  };\n  \n  posts.push(newPost);\n  \n  revalidatePath('/posts');\n  redirect('/posts');\n}\n\nexport async function deletePost(id) {\n  posts = posts.filter(p => p.id !== id);\n  revalidatePath('/posts');\n}\n\nexport async function getPosts() {\n  return posts;\n}\n\n// app/posts/new/page.js\nimport { createPost } from '../../actions';\n\nexport default function NewPostPage() {\n  return (\n    <main>\n      <h1>Create New Post</h1>\n      <form action={createPost}>\n        <div>\n          <label>Title</label>\n          <input name=\"title\" type=\"text\" required />\n        </div>\n        <div>\n          <label>Content</label>\n          <textarea name=\"content\" required />\n        </div>\n        <button type=\"submit\">Create Post</button>\n      </form>\n    </main>\n  );\n}"
    }
  ],
  "exercises": [
    {
      "id": "nextjs-api-ex-1",
      "lessonId": "nextjs-api-routes",
      "moduleId": "nextjs-data-fetching",
      "title": "Create a GET API Route",
      "difficulty": "easy",
      "description": "Create a simple API endpoint that returns JSON data",
      "instructions": "Create an API route at app/api/products/route.js that:\n1. Exports a GET function\n2. Returns a JSON array with 2 products (each having id, name, and price)\n3. Uses Response.json() to return the data",
      "starterCode": "// app/api/products/route.js\n",
      "solution": "// app/api/products/route.js\nexport async function GET() {\n  const products = [\n    { id: 1, name: 'Laptop', price: 999 },\n    { id: 2, name: 'Mouse', price: 29 }\n  ];\n  \n  return Response.json(products);\n}",
      "hints": ["Export an async GET function", "Create an array of product objects", "Use Response.json() to return data"],
      "validationPrompt": "Check if the code exports a GET function that returns a JSON array with products having id, name, and price properties"
    },
    {
      "id": "nextjs-api-ex-2",
      "lessonId": "nextjs-api-routes",
      "moduleId": "nextjs-data-fetching",
      "title": "Dynamic API Route with POST",
      "difficulty": "medium",
      "description": "Create a dynamic route that handles POST requests",
      "instructions": "Create an API route at app/api/users/[id]/route.js that:\n1. Exports a PUT function\n2. Accepts request and { params } as arguments\n3. Gets the name from the request JSON body\n4. Returns JSON with { id: params.id, name: nameFromBody, updated: true }",
      "starterCode": "// app/api/users/[id]/route.js\n",
      "solution": "// app/api/users/[id]/route.js\nexport async function PUT(request, { params }) {\n  const { name } = await request.json();\n  \n  return Response.json({\n    id: params.id,\n    name,\n    updated: true\n  });\n}",
      "hints": ["Use destructuring to get params.id", "Use request.json() to parse body", "Return Response.json with id, name, and updated flag"],
      "validationPrompt": "Check if the PUT handler uses params.id and returns JSON with id, name from body, and updated: true"
    },
    {
      "id": "nextjs-action-ex-1",
      "lessonId": "nextjs-server-actions",
      "moduleId": "nextjs-data-fetching",
      "title": "Create a Server Action",
      "difficulty": "medium",
      "description": "Create a server action for form submission",
      "instructions": "Create a server action called submitForm that:\n1. Has 'use server' directive\n2. Takes formData as parameter\n3. Gets the 'email' field from formData\n4. Returns an object with { success: true, email: emailValue }",
      "starterCode": "\n",
      "solution": "'use server';\n\nexport async function submitForm(formData) {\n  const email = formData.get('email');\n  \n  return {\n    success: true,\n    email\n  };\n}",
      "hints": ["Add 'use server' at the top", "Use formData.get() to extract values", "Return an object with success and email"],
      "validationPrompt": "Check if the server action has 'use server', accepts formData, gets email field, and returns success and email"
    }
  ]
}