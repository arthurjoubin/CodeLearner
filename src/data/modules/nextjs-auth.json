{
  "module": {
    "id": "nextjs-auth",
    "title": "Auth and Database in Next.js",
    "description": "Implement authentication and connect to databases in Next.js applications",
    "icon": "Shield",
    "requiredXp": 3400,
    "color": "from-green-500 to-emerald-600",
    "courseId": "nextjs"
  },
  "lessons": [
    {
      "id": "nextjs-auth-nextauth",
      "moduleId": "nextjs-auth",
      "title": "Authentication with NextAuth.js",
      "order": 1,
      "difficulty": "intermediate",
      "content": "# Essential to know\n- NextAuth.js = authentication library for Next.js\n- Supports OAuth (Google, GitHub, etc.) and credentials\n- Uses JWT or database sessions\n- Provides useSession hook and SessionProvider\n- Protect routes with middleware\n\n---\n\n# Authentication in Next.js with NextAuth.js\n\n## What is NextAuth.js?\n\nNextAuth.js is a complete authentication solution for Next.js:\n- OAuth providers (Google, GitHub, Discord, etc.)\n- Email/password (credentials)\n- Magic links (passwordless)\n- JWT or database sessions\n- Built-in pages (sign in, sign out, error)\n\n## Installation\n\n```bash\nnpm install next-auth\n```\n\n## Basic Setup\n\n**1. Create API route:**\n```javascript\n// app/api/auth/[...nextauth]/route.js\nimport NextAuth from 'next-auth';\nimport GoogleProvider from 'next-auth/providers/google';\n\nconst handler = NextAuth({\n  providers: [\n    GoogleProvider({\n      clientId: process.env.GOOGLE_CLIENT_ID,\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET,\n    }),\n  ],\n});\n\nexport { handler as GET, handler as POST };\n```\n\n**2. Wrap app with SessionProvider:**\n```javascript\n// app/layout.js\nimport { SessionProvider } from 'next-auth/react';\n\nexport default function RootLayout({ children }) {\n  return (\n    <SessionProvider>\n      <html>\n        <body>{children}</body>\n      </html>\n    </SessionProvider>\n  );\n}\n```\n\n**3. Use in components:**\n```javascript\n'use client';\n\nimport { useSession, signIn, signOut } from 'next-auth/react';\n\nexport default function AuthButton() {\n  const { data: session, status } = useSession();\n  \n  if (status === 'loading') {\n    return <div>Loading...</div>;\n  }\n  \n  if (session) {\n    return (\n      <div>\n        Signed in as {session.user.email}\n        <button onClick={() => signOut()}>Sign out</button>\n      </div>\n    );\n  }\n  \n  return (\n    <button onClick={() => signIn('google')}>\n      Sign in with Google\n    </button>\n  );\n}\n```\n\n## Protecting Routes\n\n**With Middleware:**\n```javascript\n// middleware.js\nimport { withAuth } from 'next-auth/middleware';\n\nexport default withAuth(\n  function middleware(req) {\n    // Additional logic here\n  },\n  {\n    callbacks: {\n      authorized({ req, token }) {\n        if (!token) return false;\n        return true;\n      },\n    },\n  }\n);\n\nexport const config = {\n  matcher: ['/dashboard/:path*', '/profile/:path*'],\n};\n```\n\n**Client-side protection:**\n```javascript\n'use client';\n\nimport { useSession } from 'next-auth/react';\nimport { redirect } from 'next/navigation';\n\nexport default function Dashboard() {\n  const { data: session, status } = useSession({\n    required: true,\n    onUnauthenticated() {\n      redirect('/api/auth/signin');\n    },\n  });\n  \n  if (status === 'loading') {\n    return <div>Loading...</div>;\n  }\n  \n  return <div>Welcome {session.user.name}!</div>;\n}\n```\n\n## Credentials Provider (Email/Password)\n\n```javascript\n// app/api/auth/[...nextauth]/route.js\nimport NextAuth from 'next-auth';\nimport CredentialsProvider from 'next-auth/providers/credentials';\n\nconst handler = NextAuth({\n  providers: [\n    CredentialsProvider({\n      name: 'credentials',\n      credentials: {\n        email: { label: 'Email', type: 'email' },\n        password: { label: 'Password', type: 'password' },\n      },\n      async authorize(credentials) {\n        // Validate credentials against database\n        const user = await db.getUserByEmail(credentials.email);\n        \n        if (user && await comparePassword(credentials.password, user.password)) {\n          return {\n            id: user.id,\n            email: user.email,\n            name: user.name,\n          };\n        }\n        \n        return null;\n      },\n    }),\n  ],\n  pages: {\n    signIn: '/auth/signin',  // Custom sign-in page\n  },\n});\n```",
      "codeExample": "// app/api/auth/[...nextauth]/route.js\nimport NextAuth from 'next-auth';\nimport GoogleProvider from 'next-auth/providers/google';\nimport GitHubProvider from 'next-auth/providers/github';\n\nconst handler = NextAuth({\n  providers: [\n    GoogleProvider({\n      clientId: process.env.GOOGLE_CLIENT_ID,\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET,\n    }),\n    GitHubProvider({\n      clientId: process.env.GITHUB_ID,\n      clientSecret: process.env.GITHUB_SECRET,\n    }),\n  ],\n  callbacks: {\n    async session({ session, token }) {\n      session.user.id = token.sub;\n      return session;\n    },\n  },\n});\n\nexport { handler as GET, handler as POST };\n\n// app/components/LoginButton.js\n'use client';\n\nimport { useSession, signIn, signOut } from 'next-auth/react';\n\nexport default function LoginButton() {\n  const { data: session } = useSession();\n  \n  if (session) {\n    return (\n      <div className=\"flex items-center gap-4\">\n        <img\n          src={session.user.image}\n          alt={session.user.name}\n          className=\"w-8 h-8 rounded-full\"\n        />\n        <span>{session.user.name}</span>\n        <button\n          onClick={() => signOut()}\n          className=\"px-4 py-2 bg-red-500 text-white rounded\"\n        >\n          Sign Out\n        </button>\n      </div>\n    );\n  }\n  \n  return (\n    <button\n      onClick={() => signIn()}\n      className=\"px-4 py-2 bg-blue-500 text-white rounded\"\n    >\n      Sign In\n    </button>\n  );\n}\n\n// middleware.js\nimport { withAuth } from 'next-auth/middleware';\n\nexport default withAuth({\n  callbacks: {\n    authorized({ token }) {\n      return token !== null;\n    },\n  },\n});\n\nexport const config = {\n  matcher: ['/dashboard/:path*', '/api/protected/:path*'] };\n"
    },
    {
      "id": "nextjs-database",
      "moduleId": "nextjs-auth",
      "title": "Connecting to Databases",
      "order": 2,
      "difficulty": "intermediate",
      "content": "# Essential to know\n- Use Prisma or Drizzle ORM for database access\n- Database calls work in Server Components and API routes\n- Environment variables for connection strings\n- Connection pooling for production\n- Server Actions can access database directly\n\n---\n\n# Database Integration in Next.js\n\n## Choosing an ORM\n\n**Prisma:**\n- Schema-first approach\n- Type-safe queries\n- Great DX and migrations\n- Most popular choice\n\n**Drizzle:**\n- SQL-like syntax\n- Smaller bundle size\n- Type-safe\n- Growing popularity\n\n## Setting Up Prisma\n\n**1. Installation:**\n```bash\nnpm install prisma @prisma/client\nnpx prisma init\n```\n\n**2. Define schema:**\n```prisma\n// prisma/schema.prisma\n\ngenerator client {\n  provider = \"prisma-client-js\"\n}\n\ndatasource db {\n  provider = \"postgresql\"\n  url      = env(\"DATABASE_URL\")\n}\n\nmodel User {\n  id        String   @id @default(uuid())\n  email     String   @unique\n  name      String?\n  posts     Post[]\n  createdAt DateTime @default(now())\n}\n\nmodel Post {\n  id       String @id @default(uuid())\n  title    String\n  content  String\n  author   User   @relation(fields: [authorId], references: [id])\n  authorId String\n}\n```\n\n**3. Environment variable:**\n```\n# .env\nDATABASE_URL=\"postgresql://user:password@localhost:5432/mydb\"\n```\n\n**4. Generate client:**\n```bash\nnpx prisma generate\nnpx prisma db push  # Create tables\n```\n\n**5. Create database client:**\n```javascript\n// lib/prisma.js\nimport { PrismaClient } from '@prisma/client';\n\nconst globalForPrisma = global;\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient();\n\nif (process.env.NODE_ENV !== 'production') {\n  globalForPrisma.prisma = prisma;\n}\n```\n\n## Using in Server Components\n\n```javascript\n// app/users/page.js\nimport { prisma } from '@/lib/prisma';\n\nexport default async function UsersPage() {\n  const users = await prisma.user.findMany({\n    include: { posts: true },\n  });\n  \n  return (\n    <main>\n      <h1>Users</h1>\n      {users.map(user => (\n        <div key={user.id}>\n          <h2>{user.name}</h2>\n          <p>Posts: {user.posts.length}</p>\n        </div>\n      ))}\n    </main>\n  );\n}\n```\n\n## Using in API Routes\n\n```javascript\n// app/api/users/route.js\nimport { prisma } from '@/lib/prisma';\n\nexport async function GET() {\n  const users = await prisma.user.findMany();\n  return Response.json(users);\n}\n\nexport async function POST(request) {\n  const body = await request.json();\n  \n  const user = await prisma.user.create({\n    data: {\n      email: body.email,\n      name: body.name,\n    },\n  });\n  \n  return Response.json(user, { status: 201 });\n}\n```\n\n## Using in Server Actions\n\n```javascript\n// app/actions.js\n'use server';\n\nimport { prisma } from '@/lib/prisma';\nimport { revalidatePath } from 'next/cache';\n\nexport async function createPost(formData) {\n  const title = formData.get('title');\n  const content = formData.get('content');\n  const authorId = formData.get('authorId');\n  \n  await prisma.post.create({\n    data: {\n      title,\n      content,\n      authorId,\n    },\n  });\n  \n  revalidatePath('/posts');\n}\n\nexport async function deletePost(id) {\n  await prisma.post.delete({\n    where: { id },\n  });\n  \n  revalidatePath('/posts');\n}\n```",
      "codeExample": "// lib/prisma.js\nimport { PrismaClient } from '@prisma/client';\n\nconst globalForPrisma = global;\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient();\n\nif (process.env.NODE_ENV !== 'production') {\n  globalForPrisma.prisma = prisma;\n}\n\n// app/api/posts/route.js\nimport { prisma } from '@/lib/prisma';\n\nexport async function GET() {\n  const posts = await prisma.post.findMany({\n    include: {\n      author: {\n        select: { name: true, email: true },\n      },\n    },\n    orderBy: { createdAt: 'desc' },\n  });\n  \n  return Response.json(posts);\n}\n\nexport async function POST(request) {\n  const { title, content, authorId } = await request.json();\n  \n  const post = await prisma.post.create({\n    data: {\n      title,\n      content,\n      authorId,\n    },\n  });\n  \n  return Response.json(post, { status: 201 });\n}\n\n// app/posts/page.js\nimport { prisma } from '@/lib/prisma';\n\nexport default async function PostsPage() {\n  const posts = await prisma.post.findMany({\n    include: { author: true },\n  });\n  \n  return (\n    <main className=\"max-w-4xl mx-auto p-4\">\n      <h1 className=\"text-3xl font-bold mb-6\">Blog Posts</h1>\n      <div className=\"space-y-4\">\n        {posts.map(post => (\n          <article key={post.id} className=\"border p-4 rounded\">\n            <h2 className=\"text-xl font-semibold\">{post.title}</h2>\n            <p className=\"text-gray-600 mb-2\">{post.content}</p>\n            <p className=\"text-sm text-gray-500\">\n              By {post.author.name} on {post.createdAt.toLocaleDateString()}\n            </p>\n          </article>\n        ))}\n      </div>\n    </main>\n  );\n}"
    },
    {
      "id": "nextjs-auth-db-integration",
      "moduleId": "nextjs-auth",
      "title": "Auth and Database Together",
      "order": 3,
      "difficulty": "advanced",
      "content": "# Essential to know\n- Store user data from OAuth providers\n- Link NextAuth.js with database\n- Protect API routes with authentication\n- RLS (Row Level Security) for data protection\n- User-specific data queries\n\n---\n\n# Integrating Auth and Database\n\n## Database Adapter for NextAuth\n\nStore session data in your database:\n\n**1. Install adapter:**\n```bash\nnpm install @auth/prisma-adapter\n```\n\n**2. Update schema:**\n```prisma\n// Add to schema.prisma\nmodel Account {\n  id                String  @id @default(cuid())\n  userId            String\n  type              String\n  provider          String\n  providerAccountId String\n  refresh_token     String? @db.Text\n  access_token      String? @db.Text\n  expires_at        Int?\n  token_type        String?\n  scope             String?\n  id_token          String? @db.Text\n  session_state     String?\n  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)\n  \n  @@unique([provider, providerAccountId])\n}\n\nmodel Session {\n  id           String   @id @default(cuid())\n  sessionToken String   @unique\n  userId       String\n  expires      DateTime\n  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)\n}\n\nmodel User {\n  id            String    @id @default(cuid())\n  name          String?\n  email         String    @unique\n  emailVerified DateTime?\n  image         String?\n  accounts      Account[]\n  sessions      Session[]\n  posts         Post[]    // Your custom relations\n}\n\nmodel VerificationToken {\n  identifier String\n  token      String   @unique\n  expires    DateTime\n  \n  @@unique([identifier, token])\n}\n```\n\n**3. Configure NextAuth with adapter:**\n```javascript\n// app/api/auth/[...nextauth]/route.js\nimport NextAuth from 'next-auth';\nimport GoogleProvider from 'next-auth/providers/google';\nimport { PrismaAdapter } from '@auth/prisma-adapter';\nimport { prisma } from '@/lib/prisma';\n\nconst handler = NextAuth({\n  adapter: PrismaAdapter(prisma),\n  providers: [\n    GoogleProvider({\n      clientId: process.env.GOOGLE_CLIENT_ID,\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET,\n    }),\n  ],\n  callbacks: {\n    async session({ session, user }) {\n      session.user.id = user.id;\n      return session;\n    },\n  },\n});\n```\n\n## Protecting Database Queries\n\n**Get current user in Server Components:**\n```javascript\nimport { getServerSession } from 'next-auth';\nimport { authOptions } from '@/app/api/auth/[...nextauth]/route';\n\nexport default async function Dashboard() {\n  const session = await getServerSession(authOptions);\n  \n  if (!session) {\n    redirect('/api/auth/signin');\n  }\n  \n  // Fetch only current user's data\n  const userPosts = await prisma.post.findMany({\n    where: {\n      authorId: session.user.id,\n    },\n  });\n  \n  return <PostsList posts={userPosts} />;\n}\n```\n\n**Protect API routes:**\n```javascript\n// app/api/user/posts/route.js\nimport { getServerSession } from 'next-auth';\nimport { authOptions } from '../../auth/[...nextauth]/route';\n\nexport async function GET() {\n  const session = await getServerSession(authOptions);\n  \n  if (!session) {\n    return Response.json(\n      { error: 'Unauthorized' },\n      { status: 401 }\n    );\n  }\n  \n  const posts = await prisma.post.findMany({\n    where: { authorId: session.user.id },\n  });\n  \n  return Response.json(posts);\n}\n```\n\n## Creating User-Specific Data\n\n```javascript\n// app/actions.js\n'use server';\n\nimport { getServerSession } from 'next-auth';\nimport { authOptions } from '@/app/api/auth/[...nextauth]/route';\n\nexport async function createPost(formData) {\n  const session = await getServerSession(authOptions);\n  \n  if (!session) {\n    throw new Error('Unauthorized');\n  }\n  \n  const title = formData.get('title');\n  const content = formData.get('content');\n  \n  const post = await prisma.post.create({\n    data: {\n      title,\n      content,\n      authorId: session.user.id,  // Link to current user\n    },\n  });\n  \n  revalidatePath('/posts');\n  return post;\n}\n```",
      "codeExample": "// app/api/auth/[...nextauth]/route.js\nimport NextAuth from 'next-auth';\nimport GoogleProvider from 'next-auth/providers/google';\nimport { PrismaAdapter } from '@auth/prisma-adapter';\nimport { prisma } from '@/lib/prisma';\n\nconst handler = NextAuth({\n  adapter: PrismaAdapter(prisma),\n  providers: [\n    GoogleProvider({\n      clientId: process.env.GOOGLE_CLIENT_ID,\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET,\n    }),\n  ],\n  callbacks: {\n    async session({ session, user }) {\n      if (session.user) {\n        session.user.id = user.id;\n      }\n      return session;\n    },\n  },\n});\n\nexport { handler as GET, handler as POST };\n\n// app/dashboard/page.js\nimport { getServerSession } from 'next-auth';\nimport { authOptions } from '@/app/api/auth/[...nextauth]/route';\nimport { prisma } from '@/lib/prisma';\nimport { redirect } from 'next/navigation';\n\nexport default async function Dashboard() {\n  const session = await getServerSession(authOptions);\n  \n  if (!session) {\n    redirect('/api/auth/signin');\n  }\n  \n  const posts = await prisma.post.findMany({\n    where: { authorId: session.user.id },\n    orderBy: { createdAt: 'desc' },\n  });\n  \n  return (\n    <main className=\"p-4\">\n      <h1 className=\"text-2xl font-bold mb-4\">\n        Welcome, {session.user.name}\n      </h1>\n      <h2 className=\"text-xl mb-4\">Your Posts ({posts.length})</h2>\n      <div className=\"space-y-4\">\n        {posts.map(post => (\n          <div key={post.id} className=\"border p-4 rounded\">\n            <h3 className=\"font-semibold\">{post.title}</h3>\n            <p className=\"text-gray-600\">{post.content}</p>\n          </div>\n        ))}\n      </div>\n    </main>\n  );\n}"
    }
  ],
  "exercises": [
    {
      "id": "nextjs-auth-ex-1",
      "lessonId": "nextjs-auth-nextauth",
      "moduleId": "nextjs-auth",
      "title": "Basic NextAuth Setup",
      "difficulty": "medium",
      "description": "Set up a basic NextAuth configuration",
      "instructions": "Create a NextAuth API route at app/api/auth/[...nextauth]/route.js that:\n1. Imports NextAuth from 'next-auth'\n2. Imports GoogleProvider from 'next-auth/providers/google'\n3. Creates a handler with GoogleProvider (use dummy clientId and clientSecret)\n4. Exports handler as GET and POST",
      "starterCode": "// app/api/auth/[...nextauth]/route.js\n",
      "solution": "// app/api/auth/[...nextauth]/route.js\nimport NextAuth from 'next-auth';\nimport GoogleProvider from 'next-auth/providers/google';\n\nconst handler = NextAuth({\n  providers: [\n    GoogleProvider({\n      clientId: process.env.GOOGLE_CLIENT_ID || 'dummy',\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET || 'dummy',\n    }),\n  ],\n});\n\nexport { handler as GET, handler as POST };",
      "hints": ["Import NextAuth and GoogleProvider", "Create handler with providers array", "Export handler as both GET and POST"],
      "validationPrompt": "Check if the code imports NextAuth and GoogleProvider, creates a handler with GoogleProvider, and exports GET and POST"
    },
    {
      "id": "nextjs-db-ex-1",
      "lessonId": "nextjs-database",
      "moduleId": "nextjs-auth",
      "title": "Database Query in API Route",
      "difficulty": "medium",
      "description": "Create an API route that queries a database",
      "instructions": "Create an API route at app/api/users/route.js that:\n1. Exports an async GET function\n2. Simulates a database call by returning an array of 3 users (id, name, email)\n3. Returns the users as JSON\n\nFor this exercise, assume prisma is not available - just return mock data.",
      "starterCode": "// app/api/users/route.js\n",
      "solution": "// app/api/users/route.js\nexport async function GET() {\n  const users = [\n    { id: 1, name: 'Alice', email: 'alice@example.com' },\n    { id: 2, name: 'Bob', email: 'bob@example.com' },\n    { id: 3, name: 'Charlie', email: 'charlie@example.com' }\n  ];\n  \n  return Response.json(users);\n}",
      "hints": ["Export async GET function", "Create array of user objects", "Return Response.json(users)"],
      "validationPrompt": "Check if the GET handler returns a JSON array with 3 users having id, name, and email properties"
    }
  ]
}