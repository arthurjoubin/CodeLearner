---
import MainLayout from '../../../layouts/MainLayout.astro';
import { getEntry, getCollection } from 'astro:content';
import { ArrowLeft, ExternalLink, CheckCircle, XCircle, ChevronDown } from 'lucide-react';

export async function getStaticPaths() {
	const llms = await getCollection('llms');
	return llms.map((llm: { slug: string }) => ({
		params: { llm: llm.slug },
		props: { slug: llm.slug },
	}));
}

const { llm: llmSlug } = Astro.params;
const llm = await getEntry('llms', llmSlug!);

if (!llm) {
	return Astro.redirect('/resources/llms');
}

const { Content } = await llm.render();
const allLlms = (await getCollection('llms')).sort((a, b) => a.data.name.localeCompare(b.data.name));

// Provider logos
const providerLogos: Record<string, string> = {
	'Anthropic': 'https://avatars.githubusercontent.com/u/76263028?s=200&v=4',
	'OpenAI': 'https://avatars.githubusercontent.com/u/14957082?s=200&v=4',
	'Google': 'https://raw.githubusercontent.com/github/explore/main/topics/google/google.png',
	'DeepSeek': 'https://avatars.githubusercontent.com/u/148330874?s=200&v=4',
	'Moonshot AI': '/images/providers/moonshot-ai.png',
	'MiniMax': '/images/providers/minimax.png',
	'Zhipu AI': '/images/providers/zhipu-ai.png',
};

function getProviderLogo(provider: string): string {
	return providerLogos[provider] || `https://ui-avatars.com/api/?name=${encodeURIComponent(provider)}&background=random&color=fff&size=128`;
}

const logoUrl = getProviderLogo(llm.data.provider);
---

<MainLayout title={`${llm.data.name} - LLM`}>
	<div class="page-enter">
		<!-- Navigation -->
		<div class="flex items-center justify-between gap-3 mb-6 flex-wrap">
			<a href="/resources/llms" class="inline-flex items-center gap-2 text-gray-800 font-bold uppercase hover:text-primary-600 transition-colors text-xs sm:text-sm">
				<ArrowLeft className="w-4 h-4" /> Back to LLMs
			</a>

			<!-- LLMs Dropdown -->
			<div class="relative llms-dropdown">
				<button class="flex items-center gap-2 px-4 py-2.5 bg-white border-2 border-gray-300 rounded-lg hover:border-primary-500 focus:border-primary-500 transition-all text-xs sm:text-sm font-bold uppercase dropdown-btn shadow-sm hover:shadow-md">
					<img src={logoUrl} alt={llm.data.provider} class="w-5 h-5 rounded object-contain" />
					{llm.data.name}
					<ChevronDown className="w-4 h-4 ml-1 transition-transform dropdown-chevron" />
				</button>
				<div class="absolute right-0 mt-2 w-56 bg-white border-2 border-gray-300 rounded-lg shadow-xl opacity-0 invisible transition-all z-50 dropdown-menu hidden max-h-72 overflow-y-auto">
					<div class="sticky top-0 bg-gray-50 border-b border-gray-200 px-4 py-2">
						<p class="text-[10px] font-bold uppercase text-gray-500">Select LLM</p>
					</div>
					{allLlms.map((l) => {
						const providerLogo = getProviderLogo(l.data.provider);
						return (
							<a
								href={`/resources/llms/${l.slug}`}
								class={`flex items-center gap-3 px-4 py-3 transition-colors border-b border-gray-100 last:border-b-0 ${
									l.slug === llmSlug
										? 'bg-primary-50 hover:bg-primary-100'
										: 'hover:bg-gray-50'
								}`}
							>
								<img src={providerLogo} alt={l.data.provider} class="w-5 h-5 rounded object-contain" />
								<div class="flex-1">
									<p class={`text-sm font-bold ${l.slug === llmSlug ? 'text-primary-700' : 'text-gray-900'}`}>{l.data.name}</p>
									<p class="text-[10px] text-gray-500">{l.data.provider}</p>
								</div>
								{l.slug === llmSlug && <div class="w-2 h-2 bg-primary-500 rounded-full"></div>}
							</a>
						);
					})}
				</div>
			</div>
		</div>

		<!-- LLM header -->
		<div class="mb-6">
			<div class="flex items-center gap-3 mb-3">
				<div class="w-14 h-14 sm:w-12 sm:h-12 rounded-lg overflow-hidden bg-white border-2 border-gray-300 flex items-center justify-center flex-shrink-0">
					<img src={logoUrl} alt={llm.data.provider} class="w-12 h-12 sm:w-10 sm:h-10 object-contain" />
				</div>
				<div>
					<h1 class="text-xl sm:text-2xl font-black text-gray-900 uppercase">{llm.data.name}</h1>
					<span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-600 rounded font-bold uppercase">
						{llm.data.provider}
					</span>
				</div>
			</div>
			<p class="text-gray-700 mt-2 text-sm sm:text-base">{llm.data.description}</p>
		</div>

		<!-- Visit button -->
		<div class="mb-6">
			<a
				href={llm.data.website}
				target="_blank"
				rel="noopener noreferrer"
				class="border-2 border-gray-300 rounded-lg px-4 py-2 bg-white hover:border-primary-500 hover:shadow-md transition-all inline-flex items-center gap-2 group"
			>
				<ExternalLink className="w-4 h-4 text-gray-500 group-hover:text-primary-600" />
				<span class="text-sm font-bold text-gray-900 group-hover:text-primary-700">Visit Website</span>
			</a>
		</div>

		{(llm.data.strengths?.length > 0 || llm.data.weaknesses?.length > 0) && (
			<div class="grid md:grid-cols-2 gap-4 mb-6">
				{llm.data.strengths?.length > 0 && (
					<div class="border-2 border-gray-300 rounded-lg p-4 bg-white">
						<div class="flex items-center gap-2 mb-3">
							<CheckCircle className="w-4 h-4 text-green-600" />
							<h3 class="text-sm font-bold text-gray-900 uppercase">Strengths</h3>
						</div>
						<ul class="space-y-2">
							{llm.data.strengths.map((s: string) => (
								<li class="text-xs text-gray-700 flex gap-2">
									<span class="text-green-600 font-bold">+</span>
									<span>{s}</span>
								</li>
							))}
						</ul>
					</div>
				)}
				{llm.data.weaknesses?.length > 0 && (
					<div class="border-2 border-gray-300 rounded-lg p-4 bg-white">
						<div class="flex items-center gap-2 mb-3">
							<XCircle className="w-4 h-4 text-red-600" />
							<h3 class="text-sm font-bold text-gray-900 uppercase">Weaknesses</h3>
						</div>
						<ul class="space-y-2">
							{llm.data.weaknesses.map((w: string) => (
								<li class="text-xs text-gray-700 flex gap-2">
									<span class="text-red-600 font-bold">-</span>
									<span>{w}</span>
								</li>
							))}
						</ul>
					</div>
				)}
			</div>
		)}

		<div class="border-2 border-gray-300 rounded-lg p-4 bg-white mb-6">
			<div class="prose prose-sm max-w-none prose-headings:font-bold prose-headings:text-gray-900 prose-a:text-primary-600 prose-a:no-underline hover:prose-a:underline prose-strong:text-gray-900 prose-strong:font-bold prose-code:bg-gray-100 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-primary-700 prose-code:font-mono prose-pre:bg-gray-900 prose-pre:text-gray-100 prose-pre:rounded-lg prose-pre:p-3">
				<Content />
			</div>
		</div>
	</div>
</MainLayout>

<script>
	// Dropdown functionality
	const dropdown = document.querySelector('.llms-dropdown');
	const btn = dropdown?.querySelector('.dropdown-btn');
	const menu = dropdown?.querySelector('.dropdown-menu');
	const chevron = btn?.querySelector('.dropdown-chevron');

	function toggleMenu() {
		const isHidden = menu?.classList.contains('hidden');
		if (isHidden) {
			menu?.classList.remove('hidden', 'opacity-0', 'invisible');
			menu?.classList.add('opacity-100', 'visible');
			chevron?.classList.add('rotate-180');
		} else {
			menu?.classList.add('hidden', 'opacity-0', 'invisible');
			menu?.classList.remove('opacity-100', 'visible');
			chevron?.classList.remove('rotate-180');
		}
	}

	btn?.addEventListener('click', (e) => {
		e.stopPropagation();
		toggleMenu();
	});

	// Close on click outside
	document.addEventListener('click', (e) => {
		if (!dropdown?.contains(e.target as Node)) {
			menu?.classList.add('hidden', 'opacity-0', 'invisible');
			menu?.classList.remove('opacity-100', 'visible');
			chevron?.classList.remove('rotate-180');
		}
	});

	// Close on escape
	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') {
			menu?.classList.add('hidden', 'opacity-0', 'invisible');
			menu?.classList.remove('opacity-100', 'visible');
			chevron?.classList.remove('rotate-180');
		}
	});
</script>
