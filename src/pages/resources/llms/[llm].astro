---
import MainLayout from '../../../layouts/MainLayout.astro';
import { getCollection, getEntry } from 'astro:content';
import { ArrowLeft, ExternalLink, CheckCircle, XCircle, Newspaper, Command, Brain, Tag } from 'lucide-react';

export async function getStaticPaths() {
	const llms = await getCollection('llms');
	return llms.map((llm: { slug: string }) => ({
		params: { llm: llm.slug },
		props: { slug: llm.slug },
	}));
}

const { llm: llmSlug } = Astro.params;
const llm = await getEntry('llms', llmSlug!);

if (!llm) {
	return Astro.redirect('/resources/llms');
}

const { Content } = await llm.render();

const allNews = await getCollection('news');

const llmName = llm.data.name;

const relatedNews = allNews.filter((n: typeof allNews[0]) => {
	const mentioned = n.data.mentionedTools || [];
	const tags = n.data.tags || [];
	return mentioned.includes(llmName) || tags.some((tag: string) => tag.toLowerCase().includes(llmName.toLowerCase()));
}).slice(0, 3);

function formatDate(date: Date | string | undefined) {
	if (!date) return '';
	const d = typeof date === 'string' ? new Date(date) : date;
	return d.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
}

// Provider logos
const providerLogos: Record<string, string> = {
	'Anthropic': 'https://avatars.githubusercontent.com/u/76263028?s=200&v=4',
	'OpenAI': 'https://avatars.githubusercontent.com/u/14957082?s=200&v=4',
	'Google': 'https://raw.githubusercontent.com/github/explore/main/topics/google/google.png',
	'DeepSeek': 'https://avatars.githubusercontent.com/u/148330874?s=200&v=4',
	'Moonshot AI': '/images/providers/moonshot-ai.png',
};

function getProviderLogo(provider: string): string {
	return providerLogos[provider] || `https://ui-avatars.com/api/?name=${encodeURIComponent(provider)}&background=random&color=fff&size=128`;
}

const logoUrl = getProviderLogo(llm.data.provider);
---

<MainLayout title={`${llm.data.name} - LLM`}>
	<div class="page-enter">
		<div class="flex items-start justify-between mb-6">
			<div class="relative inline-block group">
				<a href="/resources/llms" class="inline-flex items-center gap-2 text-gray-800 font-bold uppercase hover:text-primary-600 transition-colors text-sm">
					<ArrowLeft className="w-4 h-4" /> Back to LLMs
				</a>
				<span class="absolute -bottom-0.5 left-0 w-0 h-0.5 bg-primary-500 transition-all group-hover:w-32 duration-200" />
			</div>

			<div class="flex items-center gap-2">
				<a 
					href="/resources/news" 
					class="flex items-center gap-2 px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-primary-500 hover:shadow-md transition-all group"
					title="News"
				>
					<Newspaper className="w-4 h-4 text-gray-600 group-hover:text-primary-600" />
					<span class="text-xs font-bold text-gray-700 group-hover:text-primary-700 uppercase">News</span>
				</a>
				<a 
					href="/resources/tools" 
					class="flex items-center gap-2 px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-primary-500 hover:shadow-md transition-all group"
					title="Tools"
				>
					<Command className="w-4 h-4 text-gray-600 group-hover:text-primary-600" />
					<span class="text-xs font-bold text-gray-700 group-hover:text-primary-700 uppercase">Tools</span>
				</a>
				<a 
					href="/resources/llms" 
					class="flex items-center gap-2 px-3 py-2 bg-green-50 border-2 border-green-500 rounded-lg shadow-sm"
					title="LLMs"
				>
					<Brain className="w-4 h-4 text-green-600" />
					<span class="text-xs font-bold text-green-700 uppercase">LLMs</span>
				</a>
				<a 
					href="/resources/devfinds" 
					class="flex items-center gap-2 px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-primary-500 hover:shadow-md transition-all group"
					title="Dev Finds"
				>
					<Tag className="w-4 h-4 text-gray-600 group-hover:text-primary-600" />
					<span class="text-xs font-bold text-gray-700 group-hover:text-primary-700 uppercase">Deals</span>
				</a>
			</div>
		</div>

		<div class="mb-6">
			<div class="relative inline-block group">
				<div class="flex items-center gap-3">
					<div class="w-12 h-12 rounded-lg overflow-hidden bg-white border-2 border-gray-300 flex items-center justify-center">
						<img src={logoUrl} alt={llm.data.provider} class="w-10 h-10 object-contain" />
					</div>
					<div>
						<h1 class="text-2xl font-black text-gray-900 uppercase">{llm.data.name}</h1>
						<span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-600 rounded font-bold uppercase">
							{llm.data.provider}
						</span>
					</div>
				</div>
				<span class="absolute -bottom-0.5 left-0 w-12 h-0.5 bg-primary-500 transition-all group-hover:w-full duration-300" />
			</div>
			<p class="text-gray-700 mt-2">{llm.data.description}</p>
		</div>

		<div class="border-2 border-gray-300 rounded-lg p-4 bg-white mb-6">
			<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
				<div>
					<p class="text-[10px] text-gray-500 font-bold uppercase mb-1">Context</p>
					<p class="text-sm font-bold text-gray-900">{llm.data.contextWindow}</p>
				</div>
				<div>
					<p class="text-[10px] text-gray-500 font-bold uppercase mb-1">Pricing</p>
					<p class="text-xs font-bold text-gray-900">{llm.data.pricing}</p>
				</div>
				{llm.data.benchmarks?.slice(0, 2).map((b: { name: string; score: string }) => (
					<div>
						<p class="text-[10px] text-gray-500 font-bold uppercase mb-1">{b.name}</p>
						<p class="text-sm font-black text-primary-600">{b.score}</p>
					</div>
				))}
			</div>
			<div class="mt-4 pt-4 border-t border-gray-200">
				<a 
					href={llm.data.website} 
					target="_blank" 
					rel="noopener noreferrer"
					class="inline-flex items-center gap-2 text-sm font-bold text-gray-900 hover:text-primary-600 transition-colors"
				>
					<ExternalLink className="w-4 h-4" />
					Visit Website
				</a>
			</div>
		</div>

		{llm.data.bestFor?.length > 0 && (
			<div class="mb-6">
				<div class="relative inline-block group mb-3">
					<h2 class="font-bold text-gray-900 uppercase text-sm">Best For</h2>
					<span class="absolute -bottom-0.5 left-0 w-12 h-0.5 bg-primary-500 transition-all group-hover:w-full duration-300" />
				</div>
				<div class="flex flex-wrap gap-2">
					{llm.data.bestFor.map((b: string) => (
						<span class="text-[10px] px-3 py-1.5 bg-primary-100 text-primary-700 border border-primary-300 rounded font-bold uppercase">
							{b}
						</span>
					))}
				</div>
			</div>
		)}

		{(llm.data.strengths?.length > 0 || llm.data.weaknesses?.length > 0) && (
			<div class="grid md:grid-cols-2 gap-4 mb-6">
				{llm.data.strengths?.length > 0 && (
					<div class="border-2 border-gray-300 rounded-lg p-4 bg-white">
						<div class="flex items-center gap-2 mb-3">
							<CheckCircle className="w-4 h-4 text-green-600" />
							<h3 class="text-sm font-bold text-gray-900 uppercase">Strengths</h3>
						</div>
						<ul class="space-y-2">
							{llm.data.strengths.map((s: string) => (
								<li class="text-xs text-gray-700 flex gap-2">
									<span class="text-green-600 font-bold">+</span>
									<span>{s}</span>
								</li>
							))}
						</ul>
					</div>
				)}
				{llm.data.weaknesses?.length > 0 && (
					<div class="border-2 border-gray-300 rounded-lg p-4 bg-white">
						<div class="flex items-center gap-2 mb-3">
							<XCircle className="w-4 h-4 text-red-600" />
							<h3 class="text-sm font-bold text-gray-900 uppercase">Weaknesses</h3>
						</div>
						<ul class="space-y-2">
							{llm.data.weaknesses.map((w: string) => (
								<li class="text-xs text-gray-700 flex gap-2">
									<span class="text-red-600 font-bold">-</span>
									<span>{w}</span>
								</li>
							))}
						</ul>
					</div>
				)}
			</div>
		)}

		<div class="border-2 border-gray-300 rounded-lg p-4 bg-white mb-6">
			<div class="prose prose-sm max-w-none prose-headings:font-bold prose-headings:text-gray-900 prose-a:text-primary-600 prose-a:no-underline hover:prose-a:underline prose-strong:text-gray-900 prose-strong:font-bold prose-code:bg-gray-100 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-primary-700 prose-code:font-mono prose-pre:bg-gray-900 prose-pre:text-gray-100 prose-pre:rounded-lg prose-pre:p-3">
				<Content />
			</div>
		</div>

		{relatedNews.length > 0 && (
			<div class="mb-6">
				<div class="relative inline-block group mb-4">
					<h2 class="font-bold text-gray-900 uppercase">Related News</h2>
					<span class="absolute -bottom-0.5 left-0 w-12 h-0.5 bg-primary-500 transition-all group-hover:w-full duration-300" />
				</div>
				<div class="grid gap-4 md:grid-cols-2 p-1">
					{relatedNews.map((n: typeof allNews[0]) => (
						<a 
							href={`/resources/news/${n.slug}`} 
							class="border-2 border-gray-300 rounded-lg p-4 bg-white hover:border-primary-500 hover:shadow-md transition-all group"
						>
							<div class="flex items-center gap-2 mb-2">
								<span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-600 rounded font-bold uppercase">
									{n.data.tags[0]}
								</span>
								<span class="text-[10px] text-gray-500">{formatDate(n.data.pubDate)}</span>
							</div>
							<div class="flex items-center gap-2">
								<div class="w-2 h-2 bg-primary-500 rounded-full group-hover:scale-150 transition-transform" />
								<p class="text-sm font-bold text-gray-900 group-hover:text-primary-700 transition-colors">{n.data.title}</p>
							</div>
						</a>
					))}
				</div>
			</div>
		)}
	</div>
</MainLayout>
