---
import MainLayout from '../../layouts/MainLayout.astro';
import PageTitle from '../../components/PageTitle.astro';
import { getCollection } from 'astro:content';
import ResourceTabs from '../../components/ResourceTabs.astro';
import { ArrowLeft } from 'lucide-react';

const llmsRaw = await getCollection('llms');

// Sort: current favorite first, then by pubDate (newest first)
const llms = llmsRaw.sort((a: any, b: any) => {
	if (a.data.currentFavorite && !b.data.currentFavorite) return -1;
	if (!a.data.currentFavorite && b.data.currentFavorite) return 1;
	return new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime();
});

const llmsByProvider = llms.reduce((acc: Record<string, typeof llms>, llm: typeof llms[0]) => {
	const provider = llm.data.provider;
	if (!acc[provider]) acc[provider] = [];
	acc[provider].push(llm);
	return acc;
}, {} as Record<string, typeof llms>);

const providers = Object.keys(llmsByProvider).sort();
const totalLlms = llms.length;

// Provider logos from GitHub topics and official sources
const providerLogos: Record<string, string> = {
	'Anthropic': 'https://avatars.githubusercontent.com/u/76263028?s=200&v=4',
	'OpenAI': 'https://avatars.githubusercontent.com/u/14957082?s=200&v=4',
	'Google': 'https://raw.githubusercontent.com/github/explore/main/topics/google/google.png',
	'DeepSeek': 'https://avatars.githubusercontent.com/u/148330874?s=200&v=4',
	'Moonshot AI': '/images/providers/moonshot-ai.png',
	'MiniMax': '/images/providers/minimax.png',
	'Zhipu AI': '/images/providers/zhipu-ai.png',
};

function getProviderLogo(provider: string): string {
	return providerLogos[provider] || `https://ui-avatars.com/api/?name=${encodeURIComponent(provider)}&background=random&color=fff&size=128`;
}
---

<MainLayout title="LLM Models">
	<div class="page-enter">
		<div class="relative inline-block group mb-4">
			<a href="/resources" class="inline-flex items-center gap-2 text-gray-800 font-bold uppercase hover:text-primary-600 transition-colors text-sm">
				<ArrowLeft className="w-4 h-4" /> Back
			</a>
			<span class="absolute -bottom-0.5 left-0 w-0 h-0.5 bg-primary-500 transition-all group-hover:w-20 duration-200" />
		</div>

		<div class="mb-6">
			<PageTitle>
				<h1 slot="title" class="text-2xl font-black text-gray-900 uppercase">LLM Models</h1>
				<span slot="tag" class="px-2 py-1 bg-gray-100 text-gray-600 text-[10px] font-bold uppercase tracking-wider border border-gray-300 rounded">
					{totalLlms} models
				</span>
			</PageTitle>
			<p class="text-gray-700 mt-1">Compare AI models from {providers.length} providers</p>
		</div>

		<ResourceTabs active="llms" />

		<div class="grid gap-3 md:grid-cols-2 lg:grid-cols-3 p-1">
{llms.map((llm: typeof llms[0], index: number) => {
			const llmSlug = llm.slug;
			const logoUrl = getProviderLogo(llm.data.provider);
			const isFavorite = llm.data.currentFavorite;
			const cardClass = isFavorite
				? 'border-green-500 border-2 bg-green-50/30'
				: 'border-gray-300 border-2 bg-white';

			return (
					<a
						href={`/resources/llms/${llmSlug}`}
						class={`${cardClass} rounded-lg p-3.5 transition-all hover:border-primary-500 hover:shadow-md relative group`}
						style={`animation-delay: ${index * 50}ms`}
					>
						<div class="absolute top-3 right-3">
							{isFavorite ? (
								<span class="text-[8px] px-2 py-0.5 bg-green-500 text-white rounded-full font-bold tracking-wide">Current favorite</span>
							) : (
								<span class="text-[8px] px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full font-semibold tracking-wide">{llm.data.specialty}</span>
							)}
						</div>

					<div class="flex items-center gap-3 pr-16">
						<div class="w-11 h-11 rounded-lg overflow-hidden bg-gray-50 border border-gray-200 flex items-center justify-center shrink-0 group-hover:border-primary-300 transition-colors">
							<img src={logoUrl} alt={llm.data.provider} class="w-8 h-8 object-contain" />
						</div>
						<div class="flex-1 min-w-0">
							<h3 class="font-bold text-gray-900 uppercase text-base leading-tight group-hover:text-primary-700 transition-colors truncate">{llm.data.name}</h3>
							<p class="text-xs text-gray-500 font-medium truncate">{llm.data.provider}</p>
							{llm.data.open && (
								<p class="text-[10px] text-green-600 font-medium truncate mt-0.5">Open source</p>
							)}
						</div>
					</div>

					<div class="border-t border-gray-300 mt-4 mb-3 w-full"></div>

					<p class="text-xs text-gray-600 line-clamp-2 leading-relaxed">{llm.data.description}</p>
					</a>
				);
			})}
		</div>
	</div>
</MainLayout>
