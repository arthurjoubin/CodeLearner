---
import MainLayout from '../../layouts/MainLayout.astro';
import { getCollection } from 'astro:content';
import ResourceTabs from '../../components/ResourceTabs.astro';
import { ArrowLeft, ExternalLink } from 'lucide-react';

const devfinds = (await getCollection('devfinds')).sort(
	(a: { data: { pubDate: Date } }, b: { data: { pubDate: Date } }) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

function isExpiringSoon(expireDate?: Date): boolean {
	if (!expireDate) return false;
	const now = new Date();
	const diffDays = Math.ceil((expireDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
	return diffDays <= 7;
}

const activeDeals = devfinds.filter((d: typeof devfinds[0]) => !d.data.expireDate || d.data.expireDate > new Date()).length;

// Tool logos mapping for dev finds
const toolLogos: Record<string, string> = {
	'Cursor': 'https://avatars.githubusercontent.com/u/126825580?s=200&v=4',
	'KiloCode': 'https://ui-avatars.com/api/?name=KiloCode&background=random&color=fff&size=128',
	'MiniMax Code': 'https://ui-avatars.com/api/?name=MiniMax&background=random&color=fff&size=128',
	'Gemini Pro': 'https://raw.githubusercontent.com/github/explore/main/topics/google/google.png',
	'Gemini Ultra': 'https://raw.githubusercontent.com/github/explore/main/topics/google/google.png',
};

function getToolLogo(toolName: string): string {
	return toolLogos[toolName] || `https://ui-avatars.com/api/?name=${encodeURIComponent(toolName)}&background=random&color=fff&size=128`;
}
---

<MainLayout title="Dev Finds">
	<div class="page-enter">
		<div class="relative inline-block group mb-4">
			<a href="/resources" class="inline-flex items-center gap-2 text-gray-800 font-bold uppercase hover:text-primary-600 transition-colors text-sm">
				<ArrowLeft className="w-4 h-4" /> Back
			</a>
			<span class="absolute -bottom-0.5 left-0 w-0 h-0.5 bg-primary-500 transition-all group-hover:w-20 duration-200" />
		</div>

		<div class="mb-6">
			<div class="relative inline-block group">
				<div class="flex items-center gap-2">
					<h1 class="text-2xl font-black text-gray-900 uppercase">Dev Finds</h1>
					<span class="px-2 py-1 bg-gray-100 text-gray-600 text-[10px] font-bold uppercase tracking-wider border border-gray-300 rounded">
						{activeDeals} active
					</span>
				</div>
				<span class="absolute -bottom-0.5 left-0 w-12 h-0.5 bg-primary-500 transition-all group-hover:w-full duration-300" />
			</div>
			<p class="text-gray-700 mt-1">Limited-time offers and discounts on AI tools</p>
		</div>

		<ResourceTabs active="devfinds" />

		{devfinds.length === 0 ? (
			<div class="p-8 bg-white border-2 border-gray-300 rounded-lg text-center">
				<p class="text-gray-500 font-bold">No active deals at the moment</p>
				<p class="text-sm text-gray-400">Check back soon for new offers</p>
			</div>
		) : (
			<div class="grid gap-4 md:grid-cols-2 p-1">
				{devfinds.map((devfind: typeof devfinds[0], index: number) => {
					const mainTool = devfind.data.tools[0];
					const logoUrl = mainTool ? getToolLogo(mainTool) : null;
					return (
						<a
							href={devfind.data.url}
							target="_blank"
							rel="noopener noreferrer"
							class="border-2 border-gray-300 rounded-lg p-4 transition-all hover:border-primary-500 hover:shadow-md bg-white relative group"
							style={`animation-delay: ${index * 50}ms`}
						>
							<div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity">
								<ExternalLink className="w-4 h-4 text-gray-400" />
							</div>

							<div class="flex items-center gap-3 mb-3 pr-6">
								{logoUrl ? (
									<div class="w-10 h-10 rounded-lg overflow-hidden bg-white border border-gray-200 flex items-center justify-center">
										<img src={logoUrl} alt={mainTool} class="w-8 h-8 object-contain" />
									</div>
								) : (
									<div class="w-10 h-10 bg-primary-100 flex items-center justify-center rounded-lg">
										<span class="text-lg font-bold text-primary-700">{devfind.data.title.charAt(0)}</span>
									</div>
								)}
								<div class="flex-1 min-w-0">
									<span class={`text-[10px] px-2 py-0.5 rounded font-bold uppercase ${
										devfind.data.expireDate && isExpiringSoon(devfind.data.expireDate)
											? 'bg-red-100 text-red-600'
											: 'bg-green-100 text-green-600'
									}`}>
										{devfind.data.expireDate && isExpiringSoon(devfind.data.expireDate) ? 'Ending Soon' : 'Active'}
									</span>
								</div>
							</div>

							<div class="flex items-center gap-2 mb-1">
								<div class="w-2 h-2 bg-primary-500 rounded-full group-hover:scale-150 transition-transform" />
								<h3 class="font-bold text-gray-900 uppercase group-hover:text-primary-700 transition-colors truncate">{devfind.data.title}</h3>
							</div>
							<p class="text-xs text-gray-700 mb-3 ml-4 line-clamp-2">{devfind.data.description}</p>
							
							<div class="ml-4 flex items-center justify-between">
								<div class="flex items-center gap-2">
									<span class="text-xs text-gray-500 line-through">{devfind.data.originalPrice}</span>
									<span class="text-lg font-black text-primary-600">{devfind.data.discountedPrice}</span>
								</div>
								<span class="text-[10px] px-2 py-0.5 bg-gray-900 text-white rounded font-bold uppercase">
									{devfind.data.discount}
								</span>
							</div>
						</a>
					);
				})}
			</div>
		)}
	</div>
</MainLayout>
