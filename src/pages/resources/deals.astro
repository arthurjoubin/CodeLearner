---
import MainLayout from '../../layouts/MainLayout.astro';
import { getCollection } from 'astro:content';

const deals = (await getCollection('deals')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

function isExpiringSoon(expireDate?: Date): boolean {
	if (!expireDate) return false;
	const now = new Date();
	const diffDays = Math.ceil((expireDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
	return diffDays <= 7;
}
---

<MainLayout title="Deals">
	<div class="page-enter max-w-4xl mx-auto">
		<div class="mb-4">
			<a href="/resources" class="text-xs text-gray-500 hover:text-primary-600 uppercase font-bold flex items-center gap-1 mb-3">
				<span class="w-1.5 h-1.5 bg-primary-500 rounded-full" />
				Back to Resources
			</a>
			<div class="flex items-center justify-between">
				<div class="relative inline-block">
					<h1 class="text-xl font-black text-gray-900 uppercase">Hot Deals</h1>
					<span class="absolute -bottom-0.5 left-0 w-12 h-0.5 bg-primary-500" />
				</div>
				<div class="flex gap-2 text-xs">
					<a href="/resources/tools" class="px-2 py-1 border border-gray-300 rounded hover:bg-gray-100 transition-colors">Tools</a>
					<a href="/resources/llms" class="px-2 py-1 border border-gray-300 rounded hover:bg-gray-100 transition-colors">LLMs</a>
					<a href="/resources/news" class="px-2 py-1 border border-gray-300 rounded hover:bg-gray-100 transition-colors">News</a>
				</div>
			</div>
			<p class="text-sm text-gray-500 mt-1">Limited-time offers on AI tools</p>
		</div>

		<table class="w-full text-sm">
			<thead>
				<tr class="border-b-2 border-gray-300">
					<th class="text-left py-2 px-3 font-bold text-gray-700 uppercase text-xs w-24">Discount</th>
					<th class="text-left py-2 px-3 font-bold text-gray-700 uppercase text-xs">Deal</th>
					<th class="text-left py-2 px-3 font-bold text-gray-700 uppercase text-xs w-24">Original</th>
					<th class="text-left py-2 px-3 font-bold text-gray-700 uppercase text-xs w-24">Price</th>
					<th class="text-left py-2 px-3 font-bold text-gray-700 uppercase text-xs w-20">Status</th>
				</tr>
			</thead>
			<tbody>
				{deals.map((deal) => (
					<tr class="border-b border-gray-200 hover:bg-gray-50">
						<td class="py-2 px-3">
							<span class="text-[10px] px-2 py-0.5 bg-gray-900 text-white rounded font-bold uppercase">{deal.data.discount}</span>
						</td>
						<td class="py-2 px-3">
							<a href={deal.data.url} target="_blank" rel="noopener noreferrer" class="font-bold text-gray-900 hover:text-primary-600 truncate block">{deal.data.title}</a>
						</td>
						<td class="py-2 px-3 text-gray-500 line-through">{deal.data.originalPrice}</td>
						<td class="py-2 px-3 font-bold text-gray-900">{deal.data.discountedPrice}</td>
						<td class="py-2 px-3">
							{deal.data.expireDate && isExpiringSoon(deal.data.expireDate) ? (
								<span class="text-[10px] px-2 py-0.5 bg-red-100 text-red-600 rounded font-bold uppercase">Soon</span>
							) : (
								<span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-600 rounded font-bold uppercase">Active</span>
							)}
						</td>
					</tr>
				))}
			</tbody>
		</table>

		{deals.length === 0 && (
			<div class="p-4 bg-white border-2 border-gray-300 rounded-lg text-center">
				<p class="text-gray-500">No active deals at the moment.</p>
			</div>
		)}
	</div>
</MainLayout>
