---
import MainLayout from '../../../layouts/MainLayout.astro';
import PageTitle from '../../../components/PageTitle.astro';
import { getCollection, getEntry } from 'astro:content';
import { ArrowLeft, Calendar, User } from 'lucide-react';
import ResourceCategoryDropdown from '../../../components/ResourceCategoryDropdown.astro';

export async function getStaticPaths() {
	const news = await getCollection('news');
	return news.map((post: { slug: string }) => ({
		params: { slug: post.slug },
		props: { slug: post.slug },
	}));
}

const { slug } = Astro.params;
const post = await getEntry('news', slug!);

if (!post) {
	return Astro.redirect('/resources/news');
}

const { Content } = await post.render();

const llms = await getCollection('llms');
const tools = await getCollection('tools');

function formatDate(date: Date) {
	return date.toLocaleDateString('en-US', {
		day: 'numeric',
		month: 'long',
		year: 'numeric'
	});
}

function getToolPath(toolName: string) {
	// Check if it's an LLM
	const llmMatch = llms.find((l: typeof llms[0]) => l.data.name.toLowerCase() === toolName.toLowerCase());
	if (llmMatch) {
		return { path: `/resources/llms/${llmMatch.slug}`, isLlm: true, logo: getToolLogo(toolName) };
	}
	
	// Check if it's a tool
	const toolMatch = tools.find((t: typeof tools[0]) => t.data.name.toLowerCase() === toolName.toLowerCase());
	if (toolMatch) {
		return { path: `/resources/tools/${toolMatch.slug}`, isLlm: false, logo: getToolLogo(toolName) };
	}
	
	// Fallback: convert to slug
	const s = toolName.toLowerCase().replace(/\s+/g, '-');
	return { path: `/resources/tools/${s}`, isLlm: false, logo: null };
}

// Provider logos
const providerLogos: Record<string, string> = {
	'Anthropic': 'https://avatars.githubusercontent.com/u/76263028?s=200&v=4',
	'OpenAI': 'https://avatars.githubusercontent.com/u/14957082?s=200&v=4',
	'Google': 'https://raw.githubusercontent.com/github/explore/main/topics/google/google.png',
	'DeepSeek': 'https://avatars.githubusercontent.com/u/148330874?s=200&v=4',
};

// Tool logos
const toolLogos: Record<string, string> = {
	'Cursor': 'https://avatars.githubusercontent.com/u/126825580?s=200&v=4',
	'Claude Code': 'https://avatars.githubusercontent.com/u/76263028?s=200&v=4',
	'V0': 'https://avatars.githubusercontent.com/u/14985020?s=200&v=4',
	'Lovable': 'https://lovable.dev/favicon.ico',
	'Bolt.new': 'https://ui-avatars.com/api/?name=Bolt&background=0D8ABC&color=fff&size=128',
	'Gemini Pro': 'https://raw.githubusercontent.com/github/explore/main/topics/google/google.png',
	'Gemini Ultra': 'https://raw.githubusercontent.com/github/explore/main/topics/google/google.png',
};

function getToolLogo(toolName: string): string | null {
	return toolLogos[toolName] || providerLogos[toolName] || null;
}
---

<MainLayout title={post.data.title}>
	<div class="page-enter">
		<div class="flex items-center justify-between gap-3 mb-6 flex-wrap">
			<a href="/resources/news" class="inline-flex items-center gap-2 text-gray-800 font-bold uppercase hover:text-primary-600 transition-colors text-xs sm:text-sm">
				<ArrowLeft className="w-4 h-4" /> Back to News
			</a>

			<ResourceCategoryDropdown currentCategory="news" />
		</div>

		<div class="mb-6">
			<PageTitle>
				<h1 slot="title" class="text-2xl font-black text-gray-900">{post.data.title}</h1>
			</PageTitle>
			<div class="flex items-center gap-4 mt-3 text-xs text-gray-500">
				<div class="flex items-center gap-1">
					<User className="w-3 h-3" />
					<span class="font-bold text-gray-700">{post.data.author}</span>
				</div>
				<div class="flex items-center gap-1">
					<Calendar className="w-3 h-3" />
					<span>{formatDate(post.data.pubDate)}</span>
				</div>
			</div>
		</div>

		{post.data.mentionedTools && post.data.mentionedTools.length > 0 && (
			<div class="mb-6">
				<div class="mb-3">
					<h2 class="font-bold text-gray-900 uppercase text-sm inline">Mentioned Tools</h2>
					<span class="inline-block w-12 h-0.5 bg-primary-500 ml-2 align-middle" />
				</div>
				<div class="flex flex-wrap gap-2">
					{post.data.mentionedTools.map((toolName: string) => {
						const toolInfo = getToolPath(toolName);
						return (
							<a 
								href={toolInfo.path} 
								class="inline-flex items-center gap-2 text-[10px] px-3 py-1.5 bg-white border-2 border-gray-300 rounded font-bold uppercase hover:border-primary-500 hover:shadow-md transition-all group"
							>
								{toolInfo.logo ? (
									<img src={toolInfo.logo} alt={toolName} class="w-4 h-4 object-contain rounded" />
								) : toolInfo.isLlm ? (
									<Brain className="w-4 h-4 text-gray-500" />
								) : (
									<Wrench className="w-4 h-4 text-gray-500" />
								)}
								<span class="group-hover:text-primary-700 transition-colors">{toolName}</span>
							</a>
						);
					})}
				</div>
			</div>
		)}

		<div class="border-2 border-gray-300 rounded-lg p-4 bg-white mb-6">
			<div class="prose prose-sm max-w-none prose-headings:font-bold prose-headings:text-gray-900 prose-a:text-primary-600 prose-a:no-underline hover:prose-a:underline prose-strong:text-gray-900 prose-strong:font-bold prose-code:bg-gray-100 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-primary-700 prose-code:font-mono prose-pre:bg-gray-900 prose-pre:text-gray-100 prose-pre:rounded-lg prose-pre:p-3">
				<Content />
			</div>
		</div>

	</div>
</MainLayout>
