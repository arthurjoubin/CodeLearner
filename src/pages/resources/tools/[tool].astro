---
import MainLayout from '../../../layouts/MainLayout.astro';
import { getCollection, getEntry } from 'astro:content';
import { ArrowLeft, ExternalLink } from 'lucide-react';

export async function getStaticPaths() {
	const tools = await getCollection('tools');
	return tools.map(tool => ({
		params: { tool: tool.slug },
		props: { slug: tool.slug },
	}));
}

const { tool: toolSlug } = Astro.params;
const tool = await getEntry('tools', toolSlug!);

if (!tool) {
	return Astro.redirect('/resources/tools');
}

const { Content } = await tool.render();

const allNews = await getCollection('news');
const allDeals = await getCollection('deals');

const toolName = tool.data.name;

const relatedNews = allNews.filter(n => {
	const mentioned = n.data.mentionedTools || [];
	const tags = n.data.tags || [];
	return mentioned.includes(toolName) || tags.some(tag => tag.toLowerCase().includes(toolName.toLowerCase()));
}).slice(0, 3);

const relatedDeals = allDeals.filter(d => d.data.tools?.includes(toolName)).slice(0, 2);

function formatDate(date: Date | string | undefined) {
	if (!date) return '';
	const d = typeof date === 'string' ? new Date(date) : date;
	return d.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
}
---

<MainLayout title={`${tool.data.name} - AI Tool`}>
	<div class="page-enter max-w-3xl mx-auto">
		<div class="flex items-center gap-2 mb-4 text-xs uppercase font-bold">
			<a href="/resources" class="text-gray-500 hover:text-primary-600">Resources</a>
			<span class="text-gray-300">/</span>
			<a href="/resources/tools" class="text-gray-500 hover:text-primary-600">Tools</a>
			<span class="text-gray-300">/</span>
			<span class="text-gray-900">{tool.data.name}</span>
		</div>

		<div class="bg-white border-2 border-gray-300 rounded-lg mb-4">
			<div class="p-4">
				<div class="flex items-start gap-3 mb-3">
					<div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center text-xl font-black text-gray-700 flex-shrink-0">
						{tool.data.name.charAt(0)}
					</div>
					<div class="flex-1 min-w-0">
						<div class="flex items-center gap-2 mb-1 flex-wrap">
							<h1 class="font-bold text-lg text-gray-900">{tool.data.name}</h1>
							<span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-600 rounded font-bold uppercase">
								{tool.data.category}
							</span>
						</div>
						<p class="text-sm text-gray-600">{tool.data.description}</p>
					</div>
				</div>
				
				<div class="flex flex-wrap items-center gap-2">
					<a 
						href={tool.data.website} 
						target="_blank" 
						rel="noopener noreferrer" 
						class="inline-flex items-center gap-1 px-3 py-1.5 bg-gray-900 text-white text-xs font-bold uppercase rounded hover:bg-gray-800 transition-colors"
					>
						<ExternalLink class="w-3 h-3" />
						Website
					</a>
					{relatedDeals.length > 0 && (
						<a 
							href="/resources/deals" 
							class="inline-flex items-center gap-1 px-3 py-1.5 bg-gray-100 text-gray-700 text-xs font-bold uppercase rounded hover:bg-gray-200 transition-colors"
						>
							{relatedDeals.length} Deal{relatedDeals.length > 1 ? 's' : ''}
						</a>
					)}
				</div>
			</div>
			
			<div class="px-4 py-2 bg-gray-50 border-t-2 border-gray-200 flex flex-wrap gap-4 text-xs">
				<div>
					<span class="text-gray-500 font-bold uppercase">Pricing</span>
					<span class="ml-1 text-gray-900">{tool.data.pricing}</span>
				</div>
				<div>
					<span class="text-gray-500 font-bold uppercase">Category</span>
					<span class="ml-1 text-gray-900">{tool.data.category}</span>
				</div>
			</div>
		</div>

		{tool.data.features?.length > 0 && (
			<div class="mb-4">
				<h2 class="font-bold text-gray-900 text-xs uppercase mb-2">Features</h2>
				<div class="flex flex-wrap gap-1">
					{tool.data.features.map(f => (
						<span class="text-[10px] px-2 py-1 bg-gray-100 text-gray-700 rounded font-bold uppercase">
							{f}
						</span>
					))}
				</div>
			</div>
		)}

		{(tool.data.pros?.length > 0 || tool.data.cons?.length > 0) && (
			<div class="grid sm:grid-cols-2 gap-3 mb-4">
				{tool.data.pros?.length > 0 && (
					<div class="p-3 bg-white border-2 border-gray-300 rounded-lg">
						<h3 class="text-xs font-bold text-gray-900 uppercase mb-2">Pros</h3>
						<ul class="space-y-1">
							{tool.data.pros.map(p => (
								<li class="text-xs text-gray-700 flex gap-1">
									<span class="font-bold">+</span>
									<span>{p}</span>
								</li>
							))}
						</ul>
					</div>
				)}
				{tool.data.cons?.length > 0 && (
					<div class="p-3 bg-white border-2 border-gray-300 rounded-lg">
						<h3 class="text-xs font-bold text-gray-900 uppercase mb-2">Cons</h3>
						<ul class="space-y-1">
							{tool.data.cons.map(c => (
								<li class="text-xs text-gray-700 flex gap-1">
									<span class="font-bold">-</span>
									<span>{c}</span>
								</li>
							))}
						</ul>
					</div>
				)}
			</div>
		)}

		<div class="bg-white border-2 border-gray-300 rounded-lg p-4 mb-4">
			<div class="prose prose-sm max-w-none prose-headings:font-bold prose-headings:text-gray-900 prose-a:text-primary-600 prose-a:no-underline hover:prose-a:underline prose-strong:text-gray-900 prose-strong:font-bold prose-code:bg-gray-100 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-primary-700 prose-code:font-mono prose-pre:bg-gray-900 prose-pre:text-gray-100 prose-pre:rounded-lg prose-pre:p-3">
				<Content />
			</div>
		</div>

		{relatedNews.length > 0 && (
			<div class="mb-4">
				<h2 class="font-bold text-gray-900 text-xs uppercase mb-2">Related News</h2>
				<div class="space-y-2">
					{relatedNews.map(n => (
						<a 
							href={`/resources/news/${n.slug}`} 
							class="block p-3 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-900 transition-all"
						>
							<div class="flex items-center gap-2 mb-1">
								<span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-600 rounded font-bold uppercase">
									{n.data.tags[0]}
								</span>
								<span class="text-[10px] text-gray-400">{formatDate(n.data.pubDate)}</span>
							</div>
							<p class="text-sm font-medium text-gray-900">{n.data.title}</p>
						</a>
					))}
				</div>
			</div>
		)}

		<div class="flex items-center gap-3">
			<a 
				href="/resources/tools" 
				class="inline-flex items-center gap-1 text-xs font-bold uppercase text-gray-600 hover:text-gray-900 transition-colors"
			>
				<ArrowLeft class="w-3 h-3" />
				Back to Tools
			</a>
		</div>
	</div>
</MainLayout>
